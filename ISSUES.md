# プロジェクトの課題分析

このドキュメントは、プロジェクトの現状を分析し、確認された課題や改善点をまとめたものです。

---

## 1. Windows環境への強い依存

### 現状
本拡張機能は、.NET Frameworkでビルドされたヘルパー実行ファイル (`codex_proxy.exe`) と、その内部での `cmd.exe` の呼び出しに依存しているため、**Windows専用**となっています。

### 方針
クロスプラットフォーム対応は現状のアーキテクチャでは困難であり、スコープ外とします。本拡張機能は、意図的に **Windows環境に特化したツール**として開発・保守を継続します。この点は仕様上の制約であり、修正対象の課題ではありません。

---

## 2. 柔軟性に欠ける設定（ハードコードされた値）

### 現状
`codex` コマンドの実行に必要な設定の多くが、ソースコード内に直接書き込まれて（ハードコードされて）おり、ユーザーによるカスタマイズができません。

### 詳細
- **`codex.cmd` のパス探索:** パスは固定されていませんが、探索ロジックはハードコードされています。`codex_proxy.exe` は、まず `npm config get prefix` コマンドでnpmのグローバルパスを取得し、その中の `codex.cmd` を探します。見つからない場合のみ、フォールバックとして `%APPDATA%\\npm\\codex.cmd` を参照します。このロジックは一般的ですが、ユーザーが任意のパスを指定することはできません。
- **AIへの指示（プロンプト）:** コミットメッセージ生成のための詳細なプロンプトが、`codex_proxy/Program.cs` 内に文字列として埋め込まれています。プロンプトを微調整するには、C#コードを修正し、再コンパイルする必要があります。
- **AIモデルと引数:** `codex` に渡すモデル名 (`gpt-5`) や、その他の引数 (`model_reasoning_effort`など) も同様にハードコードされています。

### 改善案
VSCodeの `settings.json` を通じて、ユーザーが以下の項目を設定できるようにします。
- `codex.executablePath` (任意): `codex.cmd` へのフルパス。未設定の場合は現在の探索ロジックを維持。
- `codex.prompt.ja` / `codex.prompt.en`: 日本語および英語のプロンプトテンプレート。
- `codex.model`: 使用するAIモデル名。
- `codex.arguments`: モデルに渡す追加の引数（文字列または配列）。

---

## 3. メンテナンス性の課題

### 現状
拡張機能のロジックが、**TypeScript (VSCode拡張本体) と C# (.NETヘルパー) という2つの異なる技術スタックに分断**されています。

### 詳細
- **開発環境の複雑化:** プロジェクトのビルドや修正には、Node.js/TypeScriptと.NET/C#の両方の開発環境と知識が必要となり、メンテナンスのハードルを上げています。
- **ロジックの隠蔽:** `codex` CLIを呼び出すというプロジェクトの中心的な処理が、コンパイル済みのバイナリ (`codex_proxy.exe`) 内に隠蔽されています。これにより、TypeScript側から見た際の挙動が不透明になり、デバッグや機能追加が煩雑になっています。

### 方針
Windows依存は許容するため、`codex_proxy.exe` を完全に廃止することはしません。ただし、課題2で提案した設定項目を `codex_proxy.exe` が外部から受け取れるように改修することで、ロジックの透明性を高めるべきです。

---

## 4. 不安定な出力解析

### 現状
AIからの出力を解析し、コミットメッセージ本体を抽出する処理を、`■★■★■` と `▲★▲★▲` という**特殊なマーカー文字列への完全な依存**によって行っています。

### 詳細
この方法は、以下のような場合に容易に破綻する可能性があり、非常に脆弱です。
- AIの応答が変化し、マーカーを出力しなくなった場合。
- 生成されたコミットメッセージ内に、偶然マーカーと同じ文字列が含まれてしまった場合。

### 改善案
より堅牢で標準的なデータ交換形式である **JSON を採用**します。
1. プロンプトを修正し、AIに `{"commitMessage": "..."}` のようなJSON形式で出力するように指示します。
2. 拡張機能側 (`extension.ts`) で、`codex_proxy.exe` からの標準出力をJSONとしてパースし、`commitMessage` の値を取り出します。
この方法は、マーカー文字列よりも遥かに安定しており、将来的に他の情報を追加するなどの拡張も容易です。

---

## 5. セキュリティ上の懸念

### 現状
`codex` コマンドを実行する際、`--dangerously-bypass-approvals-and-sandbox` という**潜在的に危険なフラグが常に有効化**されています。

### 詳細
このフラグは、`codex` がローカルファイルへの書き込みや任意のコマンド実行といった操作を、ユーザーの承認なしに行うことを許可します。コミットメッセージを生成するという本拡張機能の目的においては、このような広範な権限は不要であり、過剰なリスクとなっています。プロンプトによる制約は絶対的な保証にはなりません。

### 改善案
- **原則としてこのフラグを削除**します。
- もしサンドボックス外での操作が必要なユースケースが存在するとしても、デフォルトでは無効とし、ユーザーがリスクを理解した上で有効化できるオプトイン設定 (`codex.enableDangerousBypass`) を用意すべきです。

---

## 6. 不親切なエラー処理

### 現状
`codex.cmd` が見つからない、実行に失敗した、といったクリティカルなエラーが発生した場合でも、その通知が**VSCodeの「出力」パネルにひっそりと表示されるだけ**です。

### 詳細
ユーザーは能動的に「出力」パネルを確認しない限り、なぜ拡張機能が動作しないのかを知ることができません。また、表示されるエラーメッセージも技術的な内容に留まり、具体的な解決策が提示されていません。

### 改善案
`vscode.window.showErrorMessage` APIを利用し、**ユーザーに分かりやすいモーダルダイアログでエラーを通知**します。
- エラーメッセージには、「`codex.cmd` が見つかりませんでした。npmでグローバルインストールされているか確認するか、設定で実行ファイルのフルパスを指定してください。」のように、考えられる原因と具体的な解決策を記載します。
